<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.leejianyang.me","root":"/","images":"/images","scheme":"Mist","version":"8.0.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta name="description" content="本文是 Slim Framework 源码阅读的第四篇，主要关于 Slim 中间件部分的实现。Slim 源码的版本是 4.5.0。">
<meta property="og:type" content="article">
<meta property="og:title" content="Slim Framework 源码阅读（四）：Middleware">
<meta property="og:url" content="https://blog.leejianyang.me/2020/05/26/slim04-middleware/index.html">
<meta property="og:site_name" content="LEE&#39;s Blog">
<meta property="og:description" content="本文是 Slim Framework 源码阅读的第四篇，主要关于 Slim 中间件部分的实现。Slim 源码的版本是 4.5.0。">
<meta property="og:locale">
<meta property="og:image" content="https://www.slimframework.com/docs/v4/images/middleware.png">
<meta property="article:published_time" content="2020-05-26T02:04:37.000Z">
<meta property="article:author" content="李剑扬">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="Web开发">
<meta property="article:tag" content="源码阅读">
<meta property="article:tag" content="Slim">
<meta property="article:tag" content="PSR">
<meta property="article:tag" content="依赖注入">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.slimframework.com/docs/v4/images/middleware.png">


<link rel="canonical" href="https://blog.leejianyang.me/2020/05/26/slim04-middleware/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh'
  };
</script>

  <title>Slim Framework 源码阅读（四）：Middleware | LEE's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LEE's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%B0%83%E7%94%A8%E6%A0%88%E7%9A%84%E6%9E%84%E9%80%A0"><span class="nav-number">1.</span> <span class="nav-text">中间件调用栈的构造</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA-Middleware-%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.1.</span> <span class="nav-text">添加一个 Middleware 对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA-callback"><span class="nav-number">1.2.</span> <span class="nav-text">添加一个 callback</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E7%B1%BB%E5%90%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9D%A5%E6%B7%BB%E5%8A%A0"><span class="nav-number">1.3.</span> <span class="nav-text">用类名字符串来添加</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%B0%83%E7%94%A8%E6%A0%88%E7%9A%84%E6%9C%80%E5%86%85%E5%B1%82"><span class="nav-number">1.4.</span> <span class="nav-text">中间件调用栈的最内层</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E8%BF%90%E8%A1%8C"><span class="nav-number">2.</span> <span class="nav-text">中间件的运行</span></a></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李剑扬</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.leejianyang.me/2020/05/26/slim04-middleware/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李剑扬">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LEE's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Slim Framework 源码阅读（四）：Middleware
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-05-26 10:04:37" itemprop="dateCreated datePublished" datetime="2020-05-26T10:04:37+08:00">2020-05-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/coding/" itemprop="url" rel="index"><span itemprop="name">coding</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>本文是 Slim Framework 源码阅读的第四篇，主要关于 Slim 中间件部分的实现。Slim 源码的版本是 4.5.0。</p>
<a id="more"></a>

<p>如 <a target="_blank" rel="noopener" href="https://www.php-fig.org/psr/psr-15/">PSR-15: HTTP Server Request Handlers</a> 所述，中间件（middleware）的作用是：</p>
<blockquote>
<p>HTTP request handlers are a fundamental part of any web application. Server-side code receives a request message, processes it, and produces a response message. HTTP middleware is a way to move common request and response processing away from the application layer.</p>
</blockquote>
<p>中间件是 web 框架中一个很重要的部分，将一些对 Request 和 Response 通用化的处理操作从业务逻辑中分离出来。PSR-15 规范了中间件应该提供的接口和相关功能。</p>
<p>每个 web 框架对中间件的具体实现方式是不一样的，Slim Framwork 的实现方式如下：</p>
<blockquote>
<p>When you run the Slim application, the Request object traverses the middleware structure from the outside in. They first enter the outer-most middleware, then the next outer-most middleware, (and so on), until they ultimately arrive at the Slim application itself. After the Slim application dispatches the appropriate route, the resultant Response object exits the Slim application and traverses the middleware structure from the inside out. Ultimately, a final Response object exits the outer-most middleware, is serialized into a raw HTTP response, and is returned to the HTTP client. Here’s a diagram that illustrates the middleware process flow:</p>
</blockquote>
<p><img src="https://www.slimframework.com/docs/v4/images/middleware.png"></p>
<p>可以同时配置多个中间件，多个中间件之间的关系可以想象成一个同心圆的结构。HTTP 请求进来的时候，最外层（也就是最后添加）的中间件最先触发，依次往内；handler 生成了 Response 后，最里层（也就是最先添加）的中间件最先触发，依次往外传递。</p>
<h2 id="中间件调用栈的构造"><a href="#中间件调用栈的构造" class="headerlink" title="中间件调用栈的构造"></a>中间件调用栈的构造</h2><p>中间件通过 MiddlewareDispatcher 进行管理，Slim 默认提供的 dispatcher 是 Slim\MiddlewareDispatcher，当然开发者可以自行替换，只要其实现 Slim\Interfaces\MiddlewareDispatcherInterface 接口即可。</p>
<h3 id="添加一个-Middleware-对象"><a href="#添加一个-Middleware-对象" class="headerlink" title="添加一个 Middleware 对象"></a>添加一个 Middleware 对象</h3><p>首先来看往 Dispatcher 中添加一个中间件的方法，这个方法属于 Slim\MiddlewareDispatcher 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addMiddleware</span>(<span class="params">MiddlewareInterface <span class="variable">$middleware</span></span>): <span class="title">MiddlewareDispatcherInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$next</span> = <span class="keyword">$this</span>-&gt;tip;</span><br><span class="line">    $this-&gt;tip = new class ($middleware, $next) implements RequestHandlerInterface &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@var</span> MiddlewareInterface</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$middleware</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@var</span> RequestHandlerInterface</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$next</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">MiddlewareInterface <span class="variable">$middleware</span>, RequestHandlerInterface <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;middleware = <span class="variable">$middleware</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;next = <span class="variable">$next</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span></span>): <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;middleware-&gt;process(<span class="variable">$request</span>, <span class="keyword">$this</span>-&gt;next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dispatcher 有点点像一个栈，最后添加的中间件最先运行，MiddlewareDispatcher 的 $tip 属性就是指向最外层的 middleware。在这个方法里面 Slim 的操作有点 trikcy，直接 new 了一个匿名类，声明了这个类实现了 Psr\Http\Server\RequestHandlerInterface 接口，这个接口同样是 PSR-15 里面规范的内容。再确切点来说，是 MiddlewareDispatcher 维护着一层一层的 RequestHandler，而每一层的 RequestHandler 中通过 Middleware 对象进行具体的处理操作。</p>
<h3 id="添加一个-callback"><a href="#添加一个-callback" class="headerlink" title="添加一个 callback"></a>添加一个 callback</h3><p>除了往 Dispatcher 中添加实现 Psr\Http\Server\MiddlewareInterface 接口的 Middleware 类外，还有一种方法是添加一个 callback。在 Slim\MiddlewareDispatcher 类中有如下方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addCallable</span>(<span class="params"><span class="keyword">callable</span> <span class="variable">$middleware</span></span>): <span class="title">self</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$next</span> = <span class="keyword">$this</span>-&gt;tip;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;container &amp;&amp; <span class="variable">$middleware</span> <span class="keyword">instanceof</span> <span class="built_in">Closure</span>) &#123;</span><br><span class="line">        <span class="variable">$middleware</span> = <span class="variable">$middleware</span>-&gt;bindTo(<span class="keyword">$this</span>-&gt;container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $this-&gt;tip = new class ($middleware, $next) implements RequestHandlerInterface &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@var</span> callable</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$middleware</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@var</span> RequestHandlerInterface</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$next</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">callable</span> <span class="variable">$middleware</span>, RequestHandlerInterface <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;middleware = <span class="variable">$middleware</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;next = <span class="variable">$next</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span></span>): <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;middleware)(<span class="variable">$request</span>, <span class="keyword">$this</span>-&gt;next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建匿名对象类的部分跟上文大同小异，不一样的地方是在 addCallable 中，会将这个 callback 绑定到依赖注入容器中。MiddlewareDispatcher 的构造函数是会接收一个依赖注入容器对象的。</p>
<h3 id="用类名字符串来添加"><a href="#用类名字符串来添加" class="headerlink" title="用类名字符串来添加"></a>用类名字符串来添加</h3><p>可以以「类名字符串」的方式，把中间件添加到栈中。在 Slim\MiddlewareDispatcher 类中有如下方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addDeferred</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$middleware</span></span>): <span class="title">self</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$next</span> = <span class="keyword">$this</span>-&gt;tip;</span><br><span class="line">    $this-&gt;tip = new class (</span><br><span class="line">        <span class="variable">$middleware</span>,</span><br><span class="line">        <span class="variable">$next</span>,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;callableResolver</span><br><span class="line">    ) <span class="keyword">implements</span> RequestHandlerInterface &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$middleware</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@var</span> RequestHandlerInterface</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$next</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@var</span> ContainerInterface|null</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$container</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@var</span> CallableResolverInterface|null</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$callableResolver</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">string</span> <span class="variable">$middleware</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            RequestHandlerInterface <span class="variable">$next</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            ?ContainerInterface <span class="variable">$container</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            ?CallableResolverInterface <span class="variable">$callableResolver</span> = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">        </span>) </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;middleware = <span class="variable">$middleware</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;next = <span class="variable">$next</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;container = <span class="variable">$container</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;callableResolver = <span class="variable">$callableResolver</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span></span>): <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;callableResolver <span class="keyword">instanceof</span> AdvancedCallableResolverInterface) &#123;</span><br><span class="line">                <span class="variable">$callable</span> = <span class="keyword">$this</span>-&gt;callableResolver-&gt;resolveMiddleware(<span class="keyword">$this</span>-&gt;middleware);</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$callable</span>(<span class="variable">$request</span>, <span class="keyword">$this</span>-&gt;next);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$callable</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;callableResolver <span class="keyword">instanceof</span> CallableResolverInterface) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="variable">$callable</span> = <span class="keyword">$this</span>-&gt;callableResolver-&gt;resolve(<span class="keyword">$this</span>-&gt;middleware);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="built_in">RuntimeException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">                    <span class="comment">// Do Nothing</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable">$callable</span>) &#123;</span><br><span class="line">                <span class="variable">$resolved</span> = <span class="keyword">$this</span>-&gt;middleware;</span><br><span class="line">                <span class="variable">$instance</span> = <span class="literal">null</span>;</span><br><span class="line">                <span class="variable">$method</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check for Slim callable as `class:method`</span></span><br><span class="line">                <span class="keyword">if</span> (preg_match(CallableResolver::<span class="variable">$callablePattern</span>, <span class="variable">$resolved</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line">                    <span class="variable">$resolved</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line">                    <span class="variable">$method</span> = <span class="variable">$matches</span>[<span class="number">2</span>];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;container &amp;&amp; <span class="keyword">$this</span>-&gt;container-&gt;has(<span class="variable">$resolved</span>)) &#123;</span><br><span class="line">                    <span class="variable">$instance</span> = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="variable">$resolved</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$instance</span> <span class="keyword">instanceof</span> MiddlewareInterface) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="variable">$instance</span>-&gt;process(<span class="variable">$request</span>, <span class="keyword">$this</span>-&gt;next);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (!function_exists(<span class="variable">$resolved</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!class_exists(<span class="variable">$resolved</span>)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(sprintf(‘Middleware %s does not exist’, <span class="variable">$resolved</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$instance</span> = <span class="keyword">new</span> <span class="variable">$resolved</span>(<span class="keyword">$this</span>-&gt;container);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$instance</span> &amp;&amp; <span class="variable">$instance</span> <span class="keyword">instanceof</span> MiddlewareInterface) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable">$instance</span>-&gt;process(<span class="variable">$request</span>, <span class="keyword">$this</span>-&gt;next);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$callable</span> = <span class="variable">$instance</span> ?? <span class="variable">$resolved</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$instance</span> &amp;&amp; <span class="variable">$method</span>) &#123;</span><br><span class="line">                    <span class="variable">$callable</span> = [<span class="variable">$instance</span>, <span class="variable">$method</span>];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;container &amp;&amp; <span class="variable">$callable</span> <span class="keyword">instanceof</span> <span class="built_in">Closure</span>) &#123;</span><br><span class="line">                    <span class="variable">$callable</span> = <span class="variable">$callable</span>-&gt;bindTo(<span class="keyword">$this</span>-&gt;container);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!is_callable(<span class="variable">$callable</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(</span><br><span class="line">                    sprintf(</span><br><span class="line">                        ‘Middleware %s is not resolvable’,</span><br><span class="line">                        <span class="keyword">$this</span>-&gt;middleware</span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$callable</span>(<span class="variable">$request</span>, <span class="keyword">$this</span>-&gt;next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我认为与「添加对象」的方式相比，「添加类名」的方式的好处在于：（1）会延迟到中间件触发的时候再对 middleware 进行更多的构造；（2）开发者引入一个符合 Psr\Http\Server\MiddlewareInterface 的类，然后由 Slim 提供的 CallableResolver 来对这个类进行更多的绑定操作，以适应 Slim 的运行机制。例如默认情况下，Slim 会使用 Slim\CallableResolver 类来进行解析封装操作，看 Slim\CallableResolver 类里面的 resolveMiddleware 方法以及其余的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveMiddleware</span>(<span class="params"><span class="variable">$toResolve</span></span>): <span class="title">callable</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resolveByPredicate(<span class="variable">$toResolve</span>, [<span class="keyword">$this</span>, ‘isMiddleware’], ‘process’);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveByPredicate</span>(<span class="params"><span class="variable">$toResolve</span>, <span class="keyword">callable</span> <span class="variable">$predicate</span>, <span class="keyword">string</span> <span class="variable">$defaultMethod</span></span>): <span class="title">callable</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_callable(<span class="variable">$toResolve</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindToContainer(<span class="variable">$toResolve</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$resolved</span> = <span class="variable">$toResolve</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$predicate</span>(<span class="variable">$toResolve</span>)) &#123;</span><br><span class="line">        <span class="variable">$resolved</span> = [<span class="variable">$toResolve</span>, <span class="variable">$defaultMethod</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_string(<span class="variable">$toResolve</span>)) &#123;</span><br><span class="line">        [<span class="variable">$instance</span>, <span class="variable">$method</span>] = <span class="keyword">$this</span>-&gt;resolveSlimNotation(<span class="variable">$toResolve</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$method</span> === <span class="literal">null</span> &amp;&amp; <span class="variable">$predicate</span>(<span class="variable">$instance</span>)) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="variable">$defaultMethod</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$resolved</span> = [<span class="variable">$instance</span>, <span class="variable">$method</span> ?? ‘__invoke’];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$callable</span> = <span class="keyword">$this</span>-&gt;assertCallable(<span class="variable">$resolved</span>, <span class="variable">$toResolve</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindToContainer(<span class="variable">$callable</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveSlimNotation</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$toResolve</span></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    preg_match(CallableResolver::<span class="variable">$callablePattern</span>, <span class="variable">$toResolve</span>, <span class="variable">$matches</span>);</span><br><span class="line">    [<span class="variable">$class</span>, <span class="variable">$method</span>] = <span class="variable">$matches</span> ? [<span class="variable">$matches</span>[<span class="number">1</span>], <span class="variable">$matches</span>[<span class="number">2</span>]] : [<span class="variable">$toResolve</span>, <span class="literal">null</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;container &amp;&amp; <span class="keyword">$this</span>-&gt;container-&gt;has(<span class="variable">$class</span>)) &#123;</span><br><span class="line">        <span class="variable">$instance</span> = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="variable">$class</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!class_exists(<span class="variable">$class</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(sprintf(‘<span class="keyword">Callable</span> %s does not exist’, <span class="variable">$class</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$instance</span> = <span class="keyword">new</span> <span class="variable">$class</span>(<span class="keyword">$this</span>-&gt;container);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="variable">$instance</span>, <span class="variable">$method</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这里也没什么特别的操作，就是返回了一个 callback，这个 callback 绑定了依赖注入容器。当然如果使用自己的 CallableResolver 的话，是可以更灵活地对 Middleware 进行更多的配置操作的。</p>
<h3 id="中间件调用栈的最内层"><a href="#中间件调用栈的最内层" class="headerlink" title="中间件调用栈的最内层"></a>中间件调用栈的最内层</h3><p>默认情况下，中间件调用栈的最内层是 Slim\Routing\RouteRunner 类，也就是进行路由操作了。因为 Slim\App 的构造函数是这样的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    ResponseFactoryInterface <span class="variable">$responseFactory</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ?ContainerInterface <span class="variable">$container</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ?CallableResolverInterface <span class="variable">$callableResolver</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ?RouteCollectorInterface <span class="variable">$routeCollector</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ?RouteResolverInterface <span class="variable">$routeResolver</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ?MiddlewareDispatcherInterface <span class="variable">$middlewareDispatcher</span> = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">parent</span>::__construct(</span><br><span class="line">        <span class="variable">$responseFactory</span>,</span><br><span class="line">        <span class="variable">$callableResolver</span> ?? <span class="keyword">new</span> CallableResolver(<span class="variable">$container</span>),</span><br><span class="line">        <span class="variable">$container</span>,</span><br><span class="line">        <span class="variable">$routeCollector</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;routeResolver = <span class="variable">$routeResolver</span> ?? <span class="keyword">new</span> RouteResolver(<span class="keyword">$this</span>-&gt;routeCollector);</span><br><span class="line">    <span class="variable">$routeRunner</span> = <span class="keyword">new</span> RouteRunner(<span class="keyword">$this</span>-&gt;routeResolver, <span class="keyword">$this</span>-&gt;routeCollector-&gt;getRouteParser(), <span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$middlewareDispatcher</span>) &#123;</span><br><span class="line">        <span class="variable">$middlewareDispatcher</span> = <span class="keyword">new</span> MiddlewareDispatcher(<span class="variable">$routeRunner</span>, <span class="keyword">$this</span>-&gt;callableResolver, <span class="variable">$container</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$middlewareDispatcher</span>-&gt;seedMiddlewareStack(<span class="variable">$routeRunner</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;middlewareDispatcher = <span class="variable">$middlewareDispatcher</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="中间件的运行"><a href="#中间件的运行" class="headerlink" title="中间件的运行"></a>中间件的运行</h2><p>看 Slim\MiddlewareDispatcher 类的运行入口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span></span>): <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;tip-&gt;handle(<span class="variable">$request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上文所述，<code>$this-&gt;tip</code> 指向的是最外层的中间件，然后递归地 handle 下去（调用下一层）。例如 Slim 本身提供的 Slim\Middleware\ContentLengthMiddleware 类的 process 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Slim</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContentLengthMiddleware</span> <span class="keyword">implements</span> <span class="title">MiddlewareInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span>, RequestHandlerInterface <span class="variable">$handler</span></span>): <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$response</span> = <span class="variable">$handler</span>-&gt;handle(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add Content-Length header if not already added</span></span><br><span class="line">        <span class="variable">$size</span> = <span class="variable">$response</span>-&gt;getBody()-&gt;getSize();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$size</span> !== <span class="literal">null</span> &amp;&amp; !<span class="variable">$response</span>-&gt;hasHeader(‘Content-Length’)) &#123;</span><br><span class="line">            <span class="variable">$response</span> = <span class="variable">$response</span>-&gt;withHeader(‘Content-Length’, (<span class="keyword">string</span>) <span class="variable">$size</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/PHP/" rel="tag"># PHP</a>
              <a href="/tags/Web%E5%BC%80%E5%8F%91/" rel="tag"># Web开发</a>
              <a href="/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="tag"># 源码阅读</a>
              <a href="/tags/Slim/" rel="tag"># Slim</a>
              <a href="/tags/PSR/" rel="tag"># PSR</a>
              <a href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/" rel="tag"># 依赖注入</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/05/25/slim03-dependency-container/" rel="prev" title="Slim Framework 源码阅读（三）：Dependency Container">
                  <i class="fa fa-chevron-left"></i> Slim Framework 源码阅读（三）：Dependency Container
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/06/02/slim05-routing/" rel="next" title="Slim Framework 源码阅读（五）：Routing">
                  Slim Framework 源码阅读（五）：Routing <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李剑扬</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

</body>
</html>
