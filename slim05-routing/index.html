<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.leejianyang.me","root":"/","images":"/images","scheme":"Mist","version":"8.0.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta name="description" content="本文是 Slim Framework 源码阅读的第五篇，主要关于 Slim 路由部分的实现。Slim 源码的版本是 4.5.0。">
<meta property="og:type" content="article">
<meta property="og:title" content="Slim Framework 源码阅读（五）：Routing">
<meta property="og:url" content="https://blog.leejianyang.me/slim05-routing/index.html">
<meta property="og:site_name" content="LEE&#39;s Blog">
<meta property="og:description" content="本文是 Slim Framework 源码阅读的第五篇，主要关于 Slim 路由部分的实现。Slim 源码的版本是 4.5.0。">
<meta property="og:locale">
<meta property="article:published_time" content="2020-06-02T09:49:52.000Z">
<meta property="article:author" content="李剑扬">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="Web开发">
<meta property="article:tag" content="源码阅读">
<meta property="article:tag" content="Slim">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.leejianyang.me/slim05-routing/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh'
  };
</script>

  <title>Slim Framework 源码阅读（五）：Routing | LEE's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LEE's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-route"><span class="nav-number">1.</span> <span class="nav-text">添加 route</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E8%A7%A3%E6%9E%90%E5%B9%B6%E6%89%A7%E8%A1%8C%E5%AF%B9%E5%BA%94-handler-%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">路由解析并执行对应 handler 的流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Routing-%E7%9A%84%E5%85%B6%E4%BD%99%E5%8A%9F%E8%83%BD"><span class="nav-number">3.</span> <span class="nav-text">Routing 的其余功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91%E5%8A%A9%E6%89%8B"><span class="nav-number">3.1.</span> <span class="nav-text">重定向助手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84"><span class="nav-number">3.2.</span> <span class="nav-text">路由分组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86-route-%E7%BB%91%E5%AE%9A%E5%88%B0-controller-%E7%B1%BB"><span class="nav-number">3.3.</span> <span class="nav-text">将 route 绑定到 controller 类</span></a></li></ol></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李剑扬</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.leejianyang.me/slim05-routing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李剑扬">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LEE's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Slim Framework 源码阅读（五）：Routing
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-06-02 17:49:52" itemprop="dateCreated datePublished" datetime="2020-06-02T17:49:52+08:00">2020-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/coding/" itemprop="url" rel="index"><span itemprop="name">coding</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>本文是 Slim Framework 源码阅读的第五篇，主要关于 Slim 路由部分的实现。Slim 源码的版本是 4.5.0。</p>
<a id="more"></a>

<h2 id="添加-route"><a href="#添加-route" class="headerlink" title="添加 route"></a>添加 route</h2><p>前文已经提到过，定义 route 的方式是通过 Slim\App 继承 Slim\Routing\RouteCollectorProxy 的一系列方法，直接来看 RouteCollectorProxy 类中的 get 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$pattern</span>, <span class="variable">$callable</span></span>): <span class="title">RouteInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;map([‘GET’], <span class="variable">$pattern</span>, <span class="variable">$callable</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$methods</span>, <span class="keyword">string</span> <span class="variable">$pattern</span>, <span class="variable">$callable</span></span>): <span class="title">RouteInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="keyword">$this</span>-&gt;groupPattern . <span class="variable">$pattern</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;routeCollector-&gt;map(<span class="variable">$methods</span>, <span class="variable">$pattern</span>, <span class="variable">$callable</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由此可见，实际创建 route 的是 RouteCollector 对象，Slim 提供的默认 collector 是 Slim\Routing\RouteCollector，里面的相关方法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$methods</span>, <span class="keyword">string</span> <span class="variable">$pattern</span>, <span class="variable">$handler</span></span>): <span class="title">RouteInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$route</span> = <span class="keyword">$this</span>-&gt;createRoute(<span class="variable">$methods</span>, <span class="variable">$pattern</span>, <span class="variable">$handler</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;routes[<span class="variable">$route</span>-&gt;getIdentifier()] = <span class="variable">$route</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;routeCounter++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$route</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createRoute</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$methods</span>, <span class="keyword">string</span> <span class="variable">$pattern</span>, <span class="variable">$callable</span></span>): <span class="title">RouteInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Route(</span><br><span class="line">        <span class="variable">$methods</span>,</span><br><span class="line">        <span class="variable">$pattern</span>,</span><br><span class="line">        <span class="variable">$callable</span>,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;responseFactory,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;callableResolver,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;defaultInvocationStrategy,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;routeGroups,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;routeCounter</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先创建一个 route 对象，然后把 Route 对象加入 RouteCollector 对象的 routes 属性里面，routes 数组记录了所有的 route，可见 RouteCollector 的作用之一就是记录并维护所有的 route。Route 类的构造函数接收的参数不少，现在先不深入来看。下一步看看请求来到之后，路由是怎样找到对应的 route 的。</p>
<h2 id="路由解析并执行对应-handler-的流程"><a href="#路由解析并执行对应-handler-的流程" class="headerlink" title="路由解析并执行对应 handler 的流程"></a>路由解析并执行对应 handler 的流程</h2><p>前文已知，在中间件调用栈的最内层，是 Slim\Routing\RouteRunner 类，看看它的 handle 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This request handler is instantiated automatically in App::__construct()</span></span><br><span class="line"><span class="comment"> * It is at the very tip of the middleware queue meaning it will be executed</span></span><br><span class="line"><span class="comment"> * last and it detects whether or not routing has been performed in the user</span></span><br><span class="line"><span class="comment"> * defined middleware stack. In the event that the user did not perform routing</span></span><br><span class="line"><span class="comment"> * it is done here</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ServerRequestInterface $request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ResponseInterface</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> HttpNotFoundException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> HttpMethodNotAllowedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span></span>): <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// If routing hasn&#x27;t been done, then do it now so we can dispatch</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$request</span>-&gt;getAttribute(RouteContext::ROUTING_RESULTS) === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="variable">$routingMiddleware</span> = <span class="keyword">new</span> RoutingMiddleware(<span class="keyword">$this</span>-&gt;routeResolver, <span class="keyword">$this</span>-&gt;routeParser);</span><br><span class="line">        <span class="variable">$request</span> = <span class="variable">$routingMiddleware</span>-&gt;performRouting(<span class="variable">$request</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;routeCollectorProxy !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="variable">$request</span> = <span class="variable">$request</span>-&gt;withAttribute(</span><br><span class="line">            RouteContext::BASE_PATH,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;routeCollectorProxy-&gt;getBasePath()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Route $route */</span></span><br><span class="line">    <span class="variable">$route</span> = <span class="variable">$request</span>-&gt;getAttribute(RouteContext::ROUTE);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$route</span>-&gt;run(<span class="variable">$request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>走进 RoutingMiddleware 类的 performRouting 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">performRouting</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span></span>): <span class="title">ServerRequestInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$routingResults</span> = <span class="keyword">$this</span>-&gt;routeResolver-&gt;computeRoutingResults(</span><br><span class="line">        <span class="variable">$request</span>-&gt;getUri()-&gt;getPath(),</span><br><span class="line">        <span class="variable">$request</span>-&gt;getMethod()</span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$routeStatus</span> = <span class="variable">$routingResults</span>-&gt;getRouteStatus();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$request</span> = <span class="variable">$request</span>-&gt;withAttribute(RouteContext::ROUTING_RESULTS, <span class="variable">$routingResults</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$routeStatus</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> RoutingResults::FOUND:</span><br><span class="line">            <span class="variable">$routeArguments</span> = <span class="variable">$routingResults</span>-&gt;getRouteArguments();</span><br><span class="line">            <span class="variable">$routeIdentifier</span> = <span class="variable">$routingResults</span>-&gt;getRouteIdentifier() ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$route</span> = <span class="keyword">$this</span>-&gt;routeResolver</span><br><span class="line">                -&gt;resolveRoute(<span class="variable">$routeIdentifier</span>)</span><br><span class="line">                -&gt;prepare(<span class="variable">$routeArguments</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$request</span>-&gt;withAttribute(RouteContext::ROUTE, <span class="variable">$route</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> RoutingResults::NOT_FOUND:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpNotFoundException(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> RoutingResults::METHOD_NOT_ALLOWED:</span><br><span class="line">            <span class="variable">$exception</span> = <span class="keyword">new</span> HttpMethodNotAllowedException(<span class="variable">$request</span>);</span><br><span class="line">            <span class="variable">$exception</span>-&gt;setAllowedMethods(<span class="variable">$routingResults</span>-&gt;getAllowedMethods());</span><br><span class="line">            <span class="keyword">throw</span> <span class="variable">$exception</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;An unexpected error occurred while performing routing.’);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里又引出了 routeResolver 对象，回溯到 Slim\App 的构造函数，可以看到默认的 routeResolver 是 Slim\Routing\RouteResolver。在 RouteResolver 里面，会发现是通过 Slim\Routing\Dispatcher 来计算路由结果。看一下 Dispatcher 类里面创建 dispatcher 的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createDispatcher</span>(<span class="params"></span>): <span class="title">FastRouteDispatcher</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;dispatcher) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$routeDefinitionCallback</span> = <span class="function"><span class="keyword">function</span> (<span class="params">FastRouteCollector <span class="variable">$r</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$basePath</span> = <span class="keyword">$this</span>-&gt;routeCollector-&gt;getBasePath();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;routeCollector-&gt;getRoutes() <span class="keyword">as</span> <span class="variable">$route</span>) &#123;</span><br><span class="line">            <span class="variable">$r</span>-&gt;addRoute(<span class="variable">$route</span>-&gt;getMethods(), <span class="variable">$basePath</span> . <span class="variable">$route</span>-&gt;getPattern(), <span class="variable">$route</span>-&gt;getIdentifier());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$cacheFile</span> = <span class="keyword">$this</span>-&gt;routeCollector-&gt;getCacheFile();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$cacheFile</span>) &#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> FastRouteDispatcher $dispatcher */</span></span><br><span class="line">        <span class="variable">$dispatcher</span> = \FastRoute\cachedDispatcher(<span class="variable">$routeDefinitionCallback</span>, [</span><br><span class="line">            <span class="string">&#x27;dispatcher&#x27;</span> =&gt; FastRouteDispatcher::class,</span><br><span class="line">            <span class="string">&#x27;routeParser&#x27;</span> =&gt; <span class="keyword">new</span> Std(),</span><br><span class="line">            <span class="string">&#x27;cacheFile&#x27;</span> =&gt; <span class="variable">$cacheFile</span>,</span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> FastRouteDispatcher $dispatcher */</span></span><br><span class="line">        <span class="variable">$dispatcher</span> = \FastRoute\simpleDispatcher(<span class="variable">$routeDefinitionCallback</span>, [</span><br><span class="line">            <span class="string">&#x27;dispatcher&#x27;</span> =&gt; FastRouteDispatcher::class,</span><br><span class="line">            <span class="string">&#x27;routeParser&#x27;</span> =&gt; <span class="keyword">new</span> Std(),</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;dispatcher = <span class="variable">$dispatcher</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatcher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由此可见，Slim 默认的路由解析是与 FastRoute 深度绑定的。FastRoute 是一个基于正则表达式实现的 router，号称速度非常快，详情见：<a target="_blank" rel="noopener" href="https://github.com/nikic/FastRoute">https://github.com/nikic/FastRoute</a>。如果开发者不想使用 FastRoute 的话，就要使用自己实现的 dispatcher 类，只要这个类实现 Slim\Interfaces\DispatcherInterface 接口即可。</p>
<p>从上面这段代码可以看出，路由解析的结果可以被文件缓存起来。要使用文件缓存，只需调用上文提到的 RouteCollector 里面的 setCacheFile 方法来设置即可。</p>
<p>当请求来到的时候，外层的中间件层都执行完毕后，会来到最内层的 Slim\Routing\RouteRunner 类，如果发现到达该层时，还没完成路由解析操作，那么此时就进行路由解析。它调用 Slim\Routing\RoutingMiddleware 的 performRouting 方法，在该方法内接着调用 Slim\ Routing\RouteResolver 的 computeRoutingResults 获取路由解析的最终结果。RouteResolver 则是借助  Slim\Routing\Dispatcher 中调用真实的 routing 组件来进行路由解析，Slim 默认使用的是 FastRoute。最终获取路由解析的结果出来之后，把结果记录在 Request 对象里面。就是上文提到的 Slim\Routing\RouteRunner 类中 handle 方法的最后两行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span></span>): <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 以上内容省略，运行到这里的时候路由解析结果已经存在于 request 对象中，route 对象就是本次请求对应的 route</span></span><br><span class="line">    <span class="variable">$route</span> = <span class="variable">$request</span>-&gt;getAttribute(RouteContext::ROUTE);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$route</span>-&gt;run(<span class="variable">$request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来看 Route 对象的 run 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span></span>): <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;groupMiddlewareAppended) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;appendGroupMiddlewareToRoute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;middlewareDispatcher-&gt;handle(<span class="variable">$request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>奇怪的是，在 Route 内部又维护了一个 MiddlewareDispatcher？在 Route 的构造函数里面有这样一行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">array</span> <span class="variable">$methods</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">string</span> <span class="variable">$pattern</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="variable">$callable</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ResponseFactoryInterface <span class="variable">$responseFactory</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    CallableResolverInterface <span class="variable">$callableResolver</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ?ContainerInterface <span class="variable">$container</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ?InvocationStrategyInterface <span class="variable">$invocationStrategy</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">array</span> <span class="variable">$groups</span> = [],</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> <span class="variable">$identifier</span> = <span class="number">0</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">	  <span class="comment">// 该方法内的其余行省略</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;middlewareDispatcher = <span class="keyword">new</span> MiddlewareDispatcher(<span class="keyword">$this</span>, <span class="variable">$callableResolver</span>, <span class="variable">$container</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见这个 MiddlewareDispatcher 不是从外部传进来的，而是由 route 对象自行创建的，这里把 $this 传给 MiddlewareDispatcher 的构造函数，根据以前章节的经验可知，在这个中间件栈里面，最内层的就是 route 自己。至于为什么在 route 对象里面还要维护一个中间件栈，暂时也不十分清楚，可能是为了给特定的一组 url 的请求额外执行一些中间件调用吧，毕竟 Slim\App 里面的中间件是所有请求都要通过执行的。</p>
<p>那 MiddlewareDispatcher 最内层执行的就是 route 对象的 handle 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">ServerRequestInterface <span class="variable">$request</span></span>): <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;callableResolver <span class="keyword">instanceof</span> AdvancedCallableResolverInterface) &#123;</span><br><span class="line">        <span class="variable">$callable</span> = <span class="keyword">$this</span>-&gt;callableResolver-&gt;resolveRoute(<span class="keyword">$this</span>-&gt;callable);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$callable</span> = <span class="keyword">$this</span>-&gt;callableResolver-&gt;resolve(<span class="keyword">$this</span>-&gt;callable);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$strategy</span> = <span class="keyword">$this</span>-&gt;invocationStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        is_array(<span class="variable">$callable</span>)</span><br><span class="line">        &amp;&amp; <span class="variable">$callable</span>[<span class="number">0</span>] <span class="keyword">instanceof</span> RequestHandlerInterface</span><br><span class="line">        &amp;&amp; !in_array(RequestHandlerInvocationStrategyInterface::class, class_implements(<span class="variable">$strategy</span>))</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="variable">$strategy</span> = <span class="keyword">new</span> RequestHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">$this</span>-&gt;responseFactory-&gt;createResponse();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$strategy</span>(<span class="variable">$callable</span>, <span class="variable">$request</span>, <span class="variable">$response</span>, <span class="keyword">$this</span>-&gt;arguments);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里出现了 strategy 的概念，看官网文档的说明：</p>
<blockquote>
<p>The route callback signature is determined by a route strategy. By default, Slim expects route callbacks to accept the request, response, and an array of route placeholder arguments. This is called the RequestResponse strategy. However, you can change the expected route callback signature by simply using a different strategy. As an example, Slim provides an alternative strategy called RequestResponseArgs that accepts request and response, plus each route placeholder as a separate argument.</p>
</blockquote>
<p>Slim 居然连 handler 接收的参数都可以替换 Orz。默认的策略类是 <code>Slim\Handlers\Strategies\RequestReponse</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestResponse</span> <span class="keyword">implements</span> <span class="title">InvocationStrategyInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoke a route callable with request, response, and all route parameters</span></span><br><span class="line"><span class="comment">     * as an array of arguments.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callable               $callable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ServerRequestInterface $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ResponseInterface      $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array&lt;mixed&gt;           $routeArguments</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ResponseInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">callable</span> <span class="variable">$callable</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        ServerRequestInterface <span class="variable">$request</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        ResponseInterface <span class="variable">$response</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">array</span> <span class="variable">$routeArguments</span></span></span></span><br><span class="line"><span class="function"><span class="params">    </span>): <span class="title">ResponseInterface</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$routeArguments</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">            <span class="variable">$request</span> = <span class="variable">$request</span>-&gt;withAttribute(<span class="variable">$k</span>, <span class="variable">$v</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$callable</span>(<span class="variable">$request</span>, <span class="variable">$response</span>, <span class="variable">$routeArguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一路下来走到这里，终于能进到 handler，整个路由解析的过程就看完了。</p>
<h2 id="Routing-的其余功能"><a href="#Routing-的其余功能" class="headerlink" title="Routing 的其余功能"></a>Routing 的其余功能</h2><p>再看一些 routing 的功能，加深一下对 routing 的了解。</p>
<h3 id="重定向助手"><a href="#重定向助手" class="headerlink" title="重定向助手"></a>重定向助手</h3><p>官网文档提供的使用示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app-&gt;redirect(<span class="string">&#x27;/books&#x27;</span>, <span class="string">&#x27;/library&#x27;</span>, <span class="number">301</span>);</span><br></pre></td></tr></table></figure>

<p>redirect 方法的定义位于 Slim\Routing\RouteCollectorProxy 类中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">redirect</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$from</span>, <span class="variable">$to</span>, <span class="keyword">int</span> <span class="variable">$status</span> = <span class="number">302</span></span>): <span class="title">RouteInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$responseFactory</span> = <span class="keyword">$this</span>-&gt;responseFactory;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$handler</span> = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params"><span class="variable">$to</span>, <span class="variable">$status</span>, <span class="variable">$responseFactory</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$response</span> = <span class="variable">$responseFactory</span>-&gt;createResponse(<span class="variable">$status</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$response</span>-&gt;withHeader(<span class="string">&#x27;Location&#x27;</span>, (<span class="keyword">string</span>) <span class="variable">$to</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="variable">$from</span>, <span class="variable">$handler</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ResponseFactory 等后续篇章说到 Response 对象的时候再说。这个 redirect 方法里面直接创建了一个 handler，在 handler 里面生成 Response 对象，设置了 Response 对象的 header（<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Redirections">具体原理可见 HTTP 协议的重定向机制</a>)，然后按上文提到的方法注册路由。</p>
<h3 id="路由分组"><a href="#路由分组" class="headerlink" title="路由分组"></a>路由分组</h3><p>官网文档提供的示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;group(<span class="string">&#x27;/users/&#123;id:[0-9]+&#125;&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">RouteCollectorProxy <span class="variable">$group</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$group</span>-&gt;map([<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;PATCH&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>], <span class="string">&#x27;&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$request</span>, <span class="variable">$response</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Find, delete, patch or replace user identified by $args[&#x27;id&#x27;]</span></span><br><span class="line">    &#125;)-&gt;setName(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$group</span>-&gt;get(<span class="string">&#x27;/reset-password&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$request</span>, <span class="variable">$response</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Route for /users/&#123;id:[0-9]+&#125;/reset-password</span></span><br><span class="line">        <span class="comment">// Reset the password for user identified by $args[&#x27;id&#x27;]</span></span><br><span class="line">    &#125;)-&gt;setName(<span class="string">&#x27;user-password-reset&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里的 group 方法定义在 Slim\Routing\RouteCollectorProxy 类中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">group</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$pattern</span>, <span class="variable">$callable</span></span>): <span class="title">RouteGroupInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="keyword">$this</span>-&gt;groupPattern . <span class="variable">$pattern</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;routeCollector-&gt;group(<span class="variable">$pattern</span>, <span class="variable">$callable</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当调用 $app 对象的 group 方法时，<code>$this-&gt;groupPattern</code> 的值是空字符串。接着调用 Slim\Routing\RouteCollector 类的 group 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">group</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$pattern</span>, <span class="variable">$callable</span></span>): <span class="title">RouteGroupInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$routeCollectorProxy</span> = <span class="keyword">new</span> RouteCollectorProxy(</span><br><span class="line">        <span class="keyword">$this</span>-&gt;responseFactory,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;callableResolver,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container,</span><br><span class="line">        <span class="keyword">$this</span>,</span><br><span class="line">        <span class="variable">$pattern</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$routeGroup</span> = <span class="keyword">new</span> RouteGroup(<span class="variable">$pattern</span>, <span class="variable">$callable</span>, <span class="keyword">$this</span>-&gt;callableResolver, <span class="variable">$routeCollectorProxy</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;routeGroups[] = <span class="variable">$routeGroup</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$routeGroup</span>-&gt;collectRoutes();</span><br><span class="line">    array_pop(<span class="keyword">$this</span>-&gt;routeGroups);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$routeGroup</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法里面又重新新建了一个 RouteCollectorProxy 对象（姑且取名为 Proxy B），从上文已经知道 RouteCollectorProxy 对象的作用是为了往 RouteCollector 里面添加 route 的，创建这个 RouteCollectorProxy 时把 RouteCollector 对象自身传递了进去，达到的效果就是新建的 RouteCollectorProxy 还是调用同一个 RouteCollector 添加 route（全局只有一个  RouteCollector）。</p>
<p>再来看 Slim\Routing\RouteGroup 类的 collectRoutes 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">collectRoutes</span>(<span class="params"></span>): <span class="title">RouteGroupInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;callableResolver <span class="keyword">instanceof</span> AdvancedCallableResolverInterface) &#123;</span><br><span class="line">        <span class="variable">$callable</span> = <span class="keyword">$this</span>-&gt;callableResolver-&gt;resolveRoute(<span class="keyword">$this</span>-&gt;callable);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$callable</span> = <span class="keyword">$this</span>-&gt;callableResolver-&gt;resolve(<span class="keyword">$this</span>-&gt;callable);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$callable</span>(<span class="keyword">$this</span>-&gt;routeCollectorProxy);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的 <code>$callable</code> 对应就是前文的匿名函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">RouteCollectorProxy <span class="variable">$group</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$group</span>-&gt;map([<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;PATCH&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>], <span class="string">&#x27;&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$request</span>, <span class="variable">$response</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Find, delete, patch or replace user identified by $args[&#x27;id&#x27;]</span></span><br><span class="line">    &#125;)-&gt;setName(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$group</span>-&gt;get(<span class="string">&#x27;/reset-password&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$request</span>, <span class="variable">$response</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Route for /users/&#123;id:[0-9]+&#125;/reset-password</span></span><br><span class="line">        <span class="comment">// Reset the password for user identified by $args[&#x27;id&#x27;]</span></span><br><span class="line">    &#125;)-&gt;setName(<span class="string">&#x27;user-password-reset&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个匿名函数接收的 RouteCollectorProxy 对象就是前文最新创建的 Proxy B，通过这个 Proxy B 调用全局唯一的 RouteCollector 对象新加入一个 route，注意 Proxy B 的 <code>groupPattern</code> 属性的值不再是空字符串而是 <code>/users/&#123;id:[0-9]+&#125;</code>，从而达到路由分组的目的，至于加入 RouteCollector 的操作跟上文的「没有分组的路由」是一样的，对于 RouteCollector 来说都是一样的 route 对象。</p>
<h3 id="将-route-绑定到-controller-类"><a href="#将-route-绑定到-controller-类" class="headerlink" title="将 route 绑定到 controller 类"></a>将 route 绑定到 controller 类</h3><p>别的框架的惯用做法是开发者创建 Controller 类，然后配置路由解析规则，HTTP 请求到来的时候，由框架调用对应的 Controller 类里面的 handler 方法。Slim 也支持这样搞，看官网的示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Container</span>\<span class="title">ContainerInterface</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeAction</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="keyword">protected</span> <span class="variable">$container</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">ContainerInterface <span class="variable">$container</span></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;container = <span class="variable">$container</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$request</span>, <span class="variable">$response</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// your code</span></span><br><span class="line">        <span class="comment">// to access items in the container... $this-&gt;container-&gt;get(&#x27;&#x27;);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span>-&gt;get(<span class="string">&#x27;/&#x27;</span>, \HomeAction::class);</span><br></pre></td></tr></table></figure>

<p>与前文不同的是，这次调用 RouteCollectorProxy 的 get 方法时传的不是回调函数了，而是直接传了字符串（Controller 的类名）。</p>
<p>前文提到，在 Slim\Routing\Route 类中的 handle 方法中会调用 <code>$this-&gt;callableResolver-&gt;resolveRoute($this-&gt;callable)</code> 函数，这里的 callable 是一个字符串。相关的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveRoute</span>(<span class="params"><span class="variable">$toResolve</span></span>): <span class="title">callable</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resolveByPredicate(<span class="variable">$toResolve</span>, [<span class="keyword">$this</span>, <span class="string">&#x27;isRoute&#x27;</span>], <span class="string">&#x27;handle&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveByPredicate</span>(<span class="params"><span class="variable">$toResolve</span>, <span class="keyword">callable</span> <span class="variable">$predicate</span>, <span class="keyword">string</span> <span class="variable">$defaultMethod</span></span>): <span class="title">callable</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_callable(<span class="variable">$toResolve</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindToContainer(<span class="variable">$toResolve</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$resolved</span> = <span class="variable">$toResolve</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$predicate</span>(<span class="variable">$toResolve</span>)) &#123;</span><br><span class="line">        <span class="variable">$resolved</span> = [<span class="variable">$toResolve</span>, <span class="variable">$defaultMethod</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_string(<span class="variable">$toResolve</span>)) &#123;</span><br><span class="line">        [<span class="variable">$instance</span>, <span class="variable">$method</span>] = <span class="keyword">$this</span>-&gt;resolveSlimNotation(<span class="variable">$toResolve</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$method</span> === <span class="literal">null</span> &amp;&amp; <span class="variable">$predicate</span>(<span class="variable">$instance</span>)) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="variable">$defaultMethod</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$resolved</span> = [<span class="variable">$instance</span>, <span class="variable">$method</span> ?? <span class="string">&#x27;__invoke&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$callable</span> = <span class="keyword">$this</span>-&gt;assertCallable(<span class="variable">$resolved</span>, <span class="variable">$toResolve</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindToContainer(<span class="variable">$callable</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveSlimNotation</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$toResolve</span></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    preg_match(CallableResolver::<span class="variable">$callablePattern</span>, <span class="variable">$toResolve</span>, <span class="variable">$matches</span>);</span><br><span class="line">    [<span class="variable">$class</span>, <span class="variable">$method</span>] = <span class="variable">$matches</span> ? [<span class="variable">$matches</span>[<span class="number">1</span>], <span class="variable">$matches</span>[<span class="number">2</span>]] : [<span class="variable">$toResolve</span>, <span class="literal">null</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;container &amp;&amp; <span class="keyword">$this</span>-&gt;container-&gt;has(<span class="variable">$class</span>)) &#123;</span><br><span class="line">        <span class="variable">$instance</span> = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="variable">$class</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!class_exists(<span class="variable">$class</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(sprintf(<span class="string">&#x27;Callable %s does not exist&#x27;</span>, <span class="variable">$class</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$instance</span> = <span class="keyword">new</span> <span class="variable">$class</span>(<span class="keyword">$this</span>-&gt;container);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="variable">$instance</span>, <span class="variable">$method</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上的代码就会将我们的类名字符串转换成一个 callable。Slim 框架没有提供一个 Controller 基类，开发者可以自己实现一个 Controller 基类，以避免每个 Controller 里面都要实现一个 <code>__invoke</code> 方法。</p>
<hr>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/PHP/" rel="tag"># PHP</a>
              <a href="/tags/Web%E5%BC%80%E5%8F%91/" rel="tag"># Web开发</a>
              <a href="/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="tag"># 源码阅读</a>
              <a href="/tags/Slim/" rel="tag"># Slim</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/slim04-middleware/" rel="prev" title="Slim Framework 源码阅读（四）：Middleware">
                  <i class="fa fa-chevron-left"></i> Slim Framework 源码阅读（四）：Middleware
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/slim06-response/" rel="next" title="Slim Framework 源码阅读（六）：Response">
                  Slim Framework 源码阅读（六）：Response <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李剑扬</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

</body>
</html>
